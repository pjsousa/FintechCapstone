#!/home/pedro/anaconda3/bin/python
from __future__ import print_function
import argparse
import sys


def dump_setup(args):
	from FintechCapstone import setup

	setup()

def dump_config(config_path):
	from FintechCapstone import dump_config

	return dump_config(config_path)

def exec_fetch(model_name, scenario, microtlist):
	from FintechCapstone import FinCapstone

	date_from = '2009-01-01'
	date_to = '2017-03-01'
	timespan = {
		"short_term": [1, 5]
		,"medium_term": [40]
		,"long_term": [90]
	}

	if scenario is None:
		scenario = "scenarioc"

	if microtlist:
		_ticker_list = ["NVDA","NFLX","AAPL"]
	else:
		_ticker_list = None

	trial = FinCapstone(
		scenario=scenario
		, ticker_list = _ticker_list
		, encode_workpages=7
		, model_name=model_name
		, ticker_list_samplesize=4000
		, timespan=timespan
		, date_from=date_from
		, reset_status=True)

	trial.run_initial_dataload()

def exec_fengineer(model_name, scenario, microtlist):
	from FintechCapstone import FinCapstone

	date_from = '2009-01-01'
	date_to = '2017-03-01'
	timespan = {
		"short_term": [1, 5]
		,"medium_term": [40]
		,"long_term": [90]
	}

	if scenario is None:
		scenario = "scenarioc"

	if microtlist:
		_ticker_list = ["NVDA","NFLX","AAPL"]
	else:
		_ticker_list = None

	trial = FinCapstone(
		scenario=scenario
		, ticker_list = _ticker_list
		, encode_workpages=7
		, model_name=model_name
		, ticker_list_samplesize=4000
		, timespan=timespan
		, date_from=date_from
		, reset_status=False)

	trial.feature_engineering()

def exec_training(model_name, scenario, microtlist, useSample, input_shape, filter_shape, output_size, FC_layers):
	from FintechCapstone import FinCapstone

	date_from = '2009-01-01'
	date_to = '2017-03-01'
	timespan = {
		"short_term": [1, 5]
		,"medium_term": [40]
		,"long_term": [90]
	}

	if scenario is None:
		scenario = "scenarioc"

	if microtlist:
		_ticker_list = ["NVDA","NFLX","AAPL"]
	else:
		_ticker_list = None

	trial = FinCapstone(
		scenario=scenario
		, ticker_list = _ticker_list
		, encode_workpages=7
		, model_name=model_name
		, ticker_list_samplesize=4000
		, timespan=timespan
		, date_from=date_from
		, reset_status=False)

	trial.train(train_next=1, nb_epoch=2000, useSample=useSample, input_shape=input_shape, filter_shape=filtersize, output_size=output_size, FC_layers=FC_layers)


def exec_fencode(model_name, scenario, microtlist, work_page, useSample, size, bins):
	from FintechCapstone import FinCapstone

	date_from = '2009-01-01'
	date_to = '2017-03-01'
	timespan = {
		"short_term": [1, 5]
		,"medium_term": [40]
		,"long_term": [90]
	}

	if scenario is None:
		scenario = "scenarioc"

	if microtlist:
		_ticker_list = ["NVDA","NFLX","AAPL"]
	else:
		_ticker_list = None

	trial = FinCapstone(
		scenario=scenario
		, ticker_list = _ticker_list
		, encode_workpages=7
		, model_name=model_name
		, ticker_list_samplesize=4000
		, timespan=timespan
		, date_from=date_from
		, reset_status=False)

	#trial.train(train_next=1, nb_epoch=5)
	trial.feature_encoding(work_page=work_page, useSample=useSample, timespan=size, bins=bins)


"""
python capstone.py --setup
python capstone.py --dump-config scenarioc
python capstone.py --config scenarioc
"""


if __name__ == "__main__":
	ap = argparse.ArgumentParser()

	ap.add_argument("--setup", required=False, help="Create directory structure.", action="store_true")
	ap.add_argument("--dump-config", required=False, help="Create dump configuration file.")
	ap.add_argument("--config", required=False, help="Configuration file to use.")
	ap.add_argument("--microtlist", required=False, help="Only use 3 tickers", action="store_true")
	ap.add_argument("--fetch", required=False, help="Execute a fetch session.", action="store_true")
	ap.add_argument("--fengineer", required=False, help="Execute a fengineer session.", action="store_true")
	ap.add_argument("--train", required=False, help="Execute a training session.", action="store_true")
	ap.add_argument("--evaluate", required=False, help="Execute an evaluation session.", action="store_true")
	ap.add_argument("--fencode", required=False, help="Perform feature encoding on the specified block.")
	ap.add_argument("--name", required=True, help="The model name.")
	ap.add_argument("--scenario", required=False, help="The scenario to use.")
	ap.add_argument("--subsample", required=False, help="The subsampling probability [0 - 100]")
	ap.add_argument("--size", required=False, help="The image side size for the mtf encoding. Used in --fencode and --train")
	ap.add_argument("--bins", required=False, help="The number of bins when performing the mtf encoding.")
	ap.add_argument("--filtersize", required=False, help="The filter side size for the convolutions.")
	ap.add_argument("--noutputs", required=False, help="The number of outputs of the model.")
	ap.add_argument("--FCBlocks", required=False, help="The number of fully connected blocks in the model.")
	ap.add_argument("--arch", required=False, help="Copies and renames the current status files of the specified model_name into an --arch name. Also copies last weights files.")


	args = None
	try:
		args = vars(ap.parse_args())
	except:
		ap.print_help()
		print("Examples: ")
		print("Calling a fetch session:")
		print("./capstonecli --name FullScenarioC --scenario scenarioc --fetch")
		print("\n\nCalling a feature engineering session:")
		print("./capstonecli --name FullScenarioC --scenario scenarioc --fengineer")
		print("\n\nCalling a feature encoding session to run the first 'page' and subsampling half of the images")
		print("./capstonecli --name FullScenarioC --scenario scenarioc --subsample 0.5 --fencode 0")
		print("\n\nAlso calling a feature encoding session but creating 120x120 images and 60 bins for the timeseries quantization.")
		print("./capstonecli --name FullScenarioC --scenario scenarioc --size 100 --bins 60 --fencode 0")
		print("\n\Calling a training session.")
		print("./capstonecli --name FullScenarioC --scenario scenarioc --train")
		print("\n\Calling a training session that also uses a sample of the images in disk.")
		print("./capstonecli --name FullScenarioC --scenario scenarioc --subsample 0.5 --train")
		print("\n\Calling a training session and overriding the model dimensions.")
		print("./capstonecli --name FullScenarioC --scenario scenarioc --size 100 --filtersize 5 --noutputs 1 --FCBlocks 2 --train")

	if args is None:
		sys.exit()

	if args["setup"]:
		dump_setup(args)

	if not(args["dump_config"] is None):
		dump_config(args["dump_config"])

	if args["fetch"]:
		exec_fetch(args["name"], args["scenario"], args["microtlist"])

	if args["fengineer"]:
		exec_fengineer(args["name"], args["scenario"], args["microtlist"])

	if not(args["fencode"] is None):
		if args["subsample"] is None:
			_subsample = 1.0
		else:
			_subsample = float(args["subsample"]) / 100.0

		if args["size"] is None :
			_size = 224
		else:
			_size = int(args["size"])

		if args["bins"] is None :
			_bins = 100
		else:
			_bins = int(args["bins"])

		exec_fencode(args["name"], args["scenario"], args["microtlist"], int(args["fencode"]), _subsample, _size, _bins)

	if args["train"]:
		if args["subsample"] is None:
			_subsample = 1.0
		else:
			_subsample = float(args["subsample"]) / 100.0

		if args["size"] is None :
			_size = (224, 224, 3)
		else:
			_size = (int(args["size"]), int(args["size"]), 3)

		if args["filtersize"] is None :
			_filtersize = (3, 3)
		else:
			_filtersize = (int(args["filtersize"]), int(args["filtersize"]))

		if args["noutputs"] is None :
			_noutputs = 3
		else:
			_noutputs = int(args["noutputs"])

		if args["FCBlocks"] is None :
			_FCBlocks = 4
		else:
			_FCBlocks = int(args["FCBlocks"])


		exec_training(args["name"], args["scenario"], args["microtlist"], _subsample, _size, _filtersize, _noutputs, _FCBlocks)



